<?xml version="1.0" encoding="UTF-8"?>
<Roadmap>
  <Phase name="Job Queue & Redis Integration">
    <Goal>Implement an asynchronous job queue system using Celery and Redis to handle interview analysis tasks.</Goal>
    <Description>
      Phase 4 focuses on decoupling long-running interview analysis tasks from the main API request/response cycle.
      We will integrate Celery as the task queue manager and Redis as the message broker and result backend.
      The FastAPI application will act as a "Producer", creating job records and pushing tasks to the queue.
      A new "Worker" service will act as a "Consumer", picking up tasks and executing them (initially stubbed).
    </Description>

    <CurrentState>
      <Exists>
        <Item>FastAPI application with Authentication and Database connection</Item>
        <Item>`ProcessingJob` model class (needs integration)</Item>
        <Item>Redis service definition in `docker-compose.yml`</Item>
        <Item>Empty `workers` directory structure</Item>
        <Item>S3 configuration settings in API</Item>
      </Exists>
      <Missing>
        <Item>Celery configuration and instance in API (Producer)</Item>
        <Item>Worker application logic (Consumer entry point)</Item>
        <Item>Job creation and status polling endpoints</Item>
        <Item>Worker service definition in `docker-compose.yml`</Item>
        <Item>Task definitions for interview processing</Item>
      </Missing>
    </CurrentState>

    <Strategy>
      <Item priority="High">Integrate **Celery** into the API to enable task offloading.</Item>
      <Item priority="High">Create a dedicated **Worker Service** to consume and execute tasks.</Item>
      <Item priority="High">Implement **Job State Tracking** (Pending -> Queued -> Processing -> Completed/Failed).</Item>
      <Item priority="Medium">Update **Docker Compose** to orchestrate the worker alongside API and Redis.</Item>
    </Strategy>

    <Steps>
      <Step order="1" type="Dependencies">
        <Action>Install Celery and dependencies.</Action>
        <Details>
          - `celery`: Task queue implementation
          - `redis`: Redis client for Python
        </Details>
        <Files>
          <File action="update">apps/api/pyproject.toml</File>
          <File action="update">workers/pyproject.toml</File>
        </Files>
      </Step>

      <Step order="2" type="Configuration">
        <Action>Configure Redis settings for API and Worker.</Action>
        <Details>
          Ensure `redis_url` is correctly defined in API configuration and create equivalent configuration for the Worker.
        </Details>
        <Files>
          <File action="update">apps/api/app/core/config.py</File>
          <File action="create">workers/app/core/config.py</File>
        </Files>
      </Step>

      <Step order="3" type="Producer">
        <Action>Implement API Producer logic.</Action>
        <Details>
          - Initialize Celery app in `apps/api/app/core/celery_utils.py`.
          - Create `JobService` to handle DB record creation and task enqueueing.
          - Implement `POST /jobs` and `GET /jobs/{id}` endpoints.
        </Details>
        <Files>
          <File action="create">apps/api/app/core/celery_utils.py</File>
          <File action="create">apps/api/app/services/job_service.py</File>
          <File action="create">apps/api/app/api/v1/endpoints/jobs.py</File>
          <File action="update">apps/api/app/main.py</File>
        </Files>
      </Step>

      <Step order="4" type="Consumer">
        <Action>Implement Worker Consumer logic.</Action>
        <Details>
          - Create Celery worker entry point (`workers/app/main.py`).
          - Define tasks in `workers/app/tasks.py`.
          - Implement `process_interview` task (stubified for now):
            - Update job status to PROCESSING.
            - Simulate delay.
            - Update job status to COMPLETED.
        </Details>
        <Files>
          <File action="create">workers/app/main.py</File>
          <File action="create">workers/app/tasks.py</File>
        </Files>
      </Step>

      <Step order="5" type="Infrastructure">
        <Action>Update Docker Compose.</Action>
        <Details>
          Add `worker` service definition:
          - Build context: `../workers`
          - Environment: REDIS_URL, DATABASE_URL
          - Command: `celery -A app.main.celery_app worker --loglevel=info`
        </Details>
        <Files>
          <File action="update">docker/docker-compose.yml</File>
        </Files>
      </Step>

      <Step order="6" type="Testing">
        <Action>Verify Integration.</Action>
        <Details>
          - Unit tests for endpoints and worker tasks.
          - Integration checks to ensure tasks flow from API -> Redis -> Worker.
        </Details>
        <Files>
          <File action="create">apps/api/tests/unit/services/test_job_service.py</File>
          <File action="create">workers/tests/test_tasks.py</File>
        </Files>
      </Step>
    </Steps>

    <Verification>
      <Test type="Automated">
        <File>apps/api/tests/unit/services/test_job_service.py</File>
        <Case>Job creation creates DB record and enqueues task</Case>
        <Case>Job retrieval returns correct status</Case>
      </Test>
      <Test type="Manual">
        <Step>Start all services: `docker-compose up --build`</Step>
        <Step>Send POST request to `/api/v1/jobs` with S3 key</Step>
        <Step>Verify response contains Job ID and status QUEUED/PENDING</Step>
        <Step>Check Worker logs for "Received task" and "Task succeeded"</Step>
        <Step>Poll GET `/api/v1/jobs/{id}` until status is COMPLETED</Step>
        <Step>Verify database record reflects COMPLETED status</Step>
      </Test>
    </Verification>

    <FutureEnhancements>
      <Item priority="Medium">Implement retry logic for failed tasks</Item>
      <Item priority="Medium">Add Dead Letter Queue (DLQ) for unprocessable jobs</Item>
      <Item priority="Low">Implement WebSocket notifications for real-time status updates</Item>
      <Item priority="Low">Add flower for Celery monitoring</Item>
    </FutureEnhancements>
  </Phase>
</Roadmap>
